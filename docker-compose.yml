version: '3'
# docker-compose up
# ref: http://postgrest.org/en/v6.0/install.html#docker
# ref: https://github.com/mattddowney/compose-postgrest/blob/master/docker-compose.yml

services:
  web:
    container_name: adopt-a-drain
    image: wilfongjt/adopt-a-drain
    build:
      context: ./adopt-a-drain-web/
    command: >
      bash -c "npm install && npm run dev"
    volumes:
      - ./adopt-a-drain-web:/usr/src
    ports:
      - "3000:3000"

  #############
  # POSTGRES
  #########
  db:
    #build: ./mockups/postgres-jwt-db
    #build: ./pg-database
    build: ./aad-db/pg-database
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=mysecretpassword
      - POSTGRES_DB=aad_db
      - DB_ANON_ROLE=guest
      - DB_SCHEMA=aad_schema
      - DB_NAME=postgres
      - DB_USER=postgres
      - DB_PASS=PASSWORD.must.BE.AT.LEAST.32.CHARS.LONG

    volumes:
      # anything in initdb directory is created in the database
      # see "How to extend this image" section at https://hub.docker.com/r/_/postgres/
      - "./aad-db/pg-database/db-scripts/compiled-scripts:/docker-entrypoint-initdb.d"
      # Uncomment this if you want to persist the data.
      - "~/.data/aad_db/pgdata:/var/lib/postgresql/data"
    networks:
      - postgrest-backend
    restart: always
  ##########
  # POSTGRREST
  #####
  api:
    container_name: postgrest
    image: postgrest/postgrest:latest
    ports:
      - "3100:3000"
    environment:
      # The standard connection URI format, documented at
      # https://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-CONNSTRING
      PGRST_DB_URI: postgres://postgres:mysecretpassword@db:5432/aad_db
      PGRST_DB_SCHEMA: aad_schema
      PGRST_DB_ANON_ROLE: guest

    depends_on:
      - db
    links:
      - db:db

    networks:
      - postgrest-backend
    restart: always
networks:
  postgrest-backend:
    driver: bridge
